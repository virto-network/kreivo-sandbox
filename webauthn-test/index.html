<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebAuthn Authentication Test for Kreivo Pass</title>
    <!-- Google Fonts -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"
    />
    <!-- CSS Reset -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css"
    />
    <!-- Milligram CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css"
    />

    <style>
      h1,
      h2 {
        text-align: center;
      }
      h1.title {
        margin-block-end: 0;
      }
      .container {
        display: flex;
        flex-direction: column;
      }
      .center {
        align-items: center;
      }
      .body-center {
        height: 100dvh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .hidden {
        display: none;
      }
      .button-disabled,
      .button-disabled:hover,
      .button-disabled:link {
        color: gray;
        background-color: lightgray;
        border-color: lightgray;
        cursor: default;
      }
      #code {
        max-height: 30vh;
        overflow: scroll;
      }
    </style>
  </head>
  <body class="body-center">
    <header class="container center">
      <h1 class="title">WebAuthn Authenticator Test</h1>
      <h3>for Kreivo Pass</h3>
    </header>
    <main class="container">
      <section class="container center">
        <div id="create" class="button">Create Credentials</div>
        <div id="authenticate" class="button button-disabled">Authenticate</div>
      </section>
      <section class="code row hidden">
        <pre class="column column-100">
        <code id="code">
          Hola Mundo
        </code>
      </pre>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/gh/paroga/cbor-js/cbor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.18/jsrsasign-all-min.js"></script>
    <script src="./authn-tools.js"></script>
    <script>
      /** @type {Credential} */
      let credential;

      document
        .querySelector("#create")
        .addEventListener("click", async (ev) => {
          ev.preventDefault();

          try {
            credential = await navigator.credentials.create({
              publicKey: {
                challenge: Uint8Array.from([0, 1, 2, 3]),
                user: {
                  id: Uint8Array.from([5, 6, 7, 8]),
                  name: "john.doe@example.org",
                  displayName: "John Doe",
                },
                rp: {
                  name: "Virto Network",
                },
                pubKeyCredParams: [
                  // ECDSA w/ SHA-256
                  { type: "public-key", alg: -7 },
                ],
                attestation: "indirect",
                authenticatorSelection: {
                  residentKey: "required",
                  // Kept for backwards compatibility reasons
                  requireResidentKey: true,
                  userVerification: "required",
                },
                attestationFormats: ["packed"],
              },
            });

            document
              .querySelector("#authenticate")
              .classList.remove("button-disabled");

            console.log(credential.toJSON());

            const clientDataJSON = credential.response.clientDataJSON;
            const clientDataString = new TextDecoder().decode(clientDataJSON);
            const clientData = JSON.parse(clientDataString);

            const attestationObject = CBOR.decode(
              credential.response.attestationObject
            );
            const authData = parseAuthenticatorData(attestationObject.authData);

            const der = coseToDerEC(
              authData.attestedCredentialData.credentialPublicKey
            );

            document.querySelector("#code").innerHTML = `// Registration result
${JSON.stringify(
  {
    ...credential,
    response: {
      attestationObject: {
        attStmt: attestationObject.attStmt,
        fmt: attestationObject.fmt,
        authData,
      },
      clientDataJSON: clientData,
    },
  },
  null,
  4
)}`;
            document.querySelector(".code").classList.remove("hidden");
          } catch (error) {
            console.error(error);
          }
        });

      document
        .querySelector("#authenticate")
        .addEventListener("click", async (ev) => {
          ev.preventDefault();

          try {
            /** @type {Credential} */
            const assertion = await navigator.credentials.get({
              mediation: "silent",
              publicKey: {
                rpId: "localhost",
                challenge: Uint8Array.from([0, 1, 2, 3]),
                allowCredentials: [
                  {
                    type: "public-key",
                    id: credential.rawId,
                  },
                ],
              },
            });

            console.log(assertion);

            const clientDataJSON = assertion.response.clientDataJSON;
            const clientDataString = new TextDecoder().decode(clientDataJSON);
            const clientData = JSON.parse(clientDataString);

            const code = document.querySelector("#code").innerHTML;
            document.querySelector("#code").innerHTML = `${code}

// Authentication result
${JSON.stringify(
  {
    ...assertion,
    response: {
      ...assertion.response,
      clientDataJSON: clientData,
      signature: `0x${toHexString(
        new Uint8Array(assertion.response.signature)
      )}`,
    },
  },
  null,
  4
)}`;
            document.querySelector(".code").classList.remove("hidden");
          } catch (error) {
            console.error(error);
          }
        });

      // Utility function to convert Uint8Array to hex string
      function toHexString(byteArray) {
        return Array.from(byteArray, (byte) =>
          byte.toString(16).padStart(2, "0")
        ).join("");
      }

      function parseAuthenticatorData(authData) {
        // Unpack authenticator data
        // https://www.w3.org/TR/webauthn/#authenticator-data
        var authenticatorData = {};
        authenticatorData.rpIdHash = window.authnTools.auto(
          authData.slice(0, 32)
        );
        authenticatorData.flags = window.authnTools
          .uint8ArrayToInt(authData.slice(32, 32 + 1))
          .toString(2);
        authenticatorData.signCount = window.authnTools.uint8ArrayToInt(
          authData.slice(32 + 1, 32 + 1 + 4)
        );
        // AttestedCredentialData
        authenticatorData.attestedCredentialData = {};
        authenticatorData.attestedCredentialData.aaguid =
          window.authnTools.auto(authData.slice(32 + 1 + 4, 32 + 1 + 4 + 16));
        authenticatorData.attestedCredentialData.credentialIdLength =
          window.authnTools.uint8ArrayToInt(
            authData.slice(32 + 1 + 4 + 16, 32 + 1 + 4 + 16 + 2)
          );
        var length =
          authenticatorData.attestedCredentialData.credentialIdLength;
        authenticatorData.attestedCredentialData.credentialId =
          window.authnTools.auto(
            authData.slice(32 + 1 + 4 + 16 + 2, 32 + 1 + 4 + 16 + 2 + length)
          );
        var lastCBORObjects = CBOR.decode(
          authData.slice(32 + 1 + 4 + 16 + 2 + length, authData.length).buffer
        );
        authenticatorData.attestedCredentialData.credentialPublicKey =
          lastCBORObjects;
        if (lastCBORObjects.length > 1)
          authenticatorData.attestedCredentialData.extensions =
            lastCBORObjects[1];

        var pubkey =
          authenticatorData.attestedCredentialData.credentialPublicKey;
        for (let i in pubkey) {
          if (pubkey.hasOwnProperty(i) && pubkey[i] instanceof Uint8Array) {
            pubkey[i] = window.authnTools.auto(pubkey[i]);
          }
        }

        return authenticatorData;
      }

      function base64UrlToUint8Array(base64Url) {
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const padding = "=".repeat((4 - (base64.length % 4)) % 4);
        const binaryString = atob(base64 + padding);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
      }

      // Function to encode the COSE public key into DER format
      function coseToDerEC(coseKey) {
        // Extract X and Y coordinates from the COSE key
        const x = base64UrlToUint8Array(coseKey["-2"]);
        const y = base64UrlToUint8Array(coseKey["-3"]);

        // Construct uncompressed public key (0x04 || X || Y)
        const uncompressedKey = new Uint8Array(1 + x.length + y.length);
        uncompressedKey[0] = 0x04; // Indicates uncompressed point format
        uncompressedKey.set(x, 1);
        uncompressedKey.set(y, 1 + x.length);

        // ASN.1 encoding (manual)
        const ecPublicKeyOID = "06072a8648ce3d0201"; // OID for ecPublicKey
        const prime256v1OID = "06082a8648ce3d030107"; // OID for P-256 (prime256v1)

        // BIT STRING prefix for the public key
        const bitStringPrefix =
          "03" +
          (uncompressedKey.length + 1).toString(16).padStart(2, "0") +
          "00";

        // Sequence encoding
        const publicKeyHex =
          "30" +
          (
            ecPublicKeyOID.length / 2 +
            prime256v1OID.length / 2 +
            bitStringPrefix.length / 2 +
            uncompressedKey.length
          )
            .toString(16)
            .padStart(2, "0") +
          "30" +
          (ecPublicKeyOID.length / 2 + prime256v1OID.length / 2)
            .toString(16)
            .padStart(2, "0") +
          ecPublicKeyOID +
          prime256v1OID +
          bitStringPrefix +
          toHexString(uncompressedKey);

        return publicKeyHex; // Return the DER-encoded EC public key as a hex string
      }
    </script>
  </body>
</html>
